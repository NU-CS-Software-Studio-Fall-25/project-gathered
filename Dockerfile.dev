# syntax=docker/dockerfile:1
# check=error=true

# --- Base setup ---
ARG RUBY_VERSION=3.4.1
FROM docker.io/library/ruby:$RUBY_VERSION-slim

# Rails app lives here
WORKDIR /rails

# --- Install dependencies ---
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
      build-essential git curl libyaml-dev pkg-config \
      libvips sqlite3 dos2unix inotify-tools watchman && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# --- Environment variables ---
ENV RAILS_ENV="development" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT=""

# --- Install gems ---
COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache

# --- Copy application code ---
COPY . .

# --- Normalize line endings (avoid \r issues from Windows) ---
RUN find ./bin -type f -exec dos2unix {} + && \
    find ./ -type f -name "*.sh" -exec dos2unix {} +

# --- Add listen gem if not present (for file watching inside Docker) ---
RUN bundle add listen --version "~> 3.8" || true

# --- Expose Rails dev port ---
EXPOSE 3000

# --- Default command: start Rails with live reload ---
CMD ["bin/dev"]
